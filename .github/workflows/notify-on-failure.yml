name: Notify on Failure

on:
  workflow_run:
    workflows: ['Quick Checks', 'Feature Tests', 'Comprehensive Tests']
    types: [completed]

jobs:
  notify:
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    runs-on: ubuntu-latest
    steps:
      - name: Get failed workflow info
        id: info
        run: |
          echo "workflow=${{ github.event.workflow_run.name }}" >> $GITHUB_OUTPUT
          echo "branch=${{ github.event.workflow_run.head_branch }}" >> $GITHUB_OUTPUT
          echo "url=${{ github.event.workflow_run.html_url }}" >> $GITHUB_OUTPUT
          echo "commit=${{ github.event.workflow_run.head_sha }}" >> $GITHUB_OUTPUT

      - name: Create failure issue
        uses: actions/github-script@v7
        with:
          script: |
            const title = `CI Failure: ${{ steps.info.outputs.workflow }} on ${{ steps.info.outputs.branch }}`;
            const body = [
              `## CI Failure Report`,
              ``,
              `**Workflow:** ${{ steps.info.outputs.workflow }}`,
              `**Branch:** ${{ steps.info.outputs.branch }}`,
              `**Commit:** \`${{ steps.info.outputs.commit }}\``,
              `**Run:** ${{ steps.info.outputs.url }}`,
              ``,
              `Check the [workflow run](${{ steps.info.outputs.url }}) for details on what failed.`,
              ``,
              `---`,
              `*Auto-generated by CI failure notification*`
            ].join('\n');

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['ci-failure']
            });
